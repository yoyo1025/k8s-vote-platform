_format_version: "3.0"

services:
  - name: auth
    url: http://host.docker.internal:18080
  - name: result-api
    url: http://host.docker.internal:8080

routes:
  - name: auth-routes
    service: auth
    paths: ["/auth", "/.well-known"]
    strip_path: false
    methods: ["GET","POST"]

  - name: api-routes
    service: result-api
    paths: ["/api/v1"]
    strip_path: false
    methods: ["GET","POST"]
    plugins:
      - name: jwt
        config:
          key_claim_name: iss          # JWTの "iss" をキーに照合
          claims_to_verify: ["exp"]    # exp 検証
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET","POST"]
          headers: ["Authorization","Content-Type","Accept"]
          credentials: false
          max_age: 3600

# ←ここがポイント（固定公開鍵を登録）
consumers:
  - username: dev-issuer
    custom_id: "http://localhost:18080"   # 覚書（任意）

jwt_secrets:
  - consumer: dev-issuer
    algorithm: RS256
    key: "http://localhost:18080"         # ← トークンの iss と一致させる
    rsa_public_key: |-
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAz+K42b7FynkFEUVigWSG
      x646y8hrAQdOqxXUf77td/A1pS+3Jrh7kXnme2ywmFiaMbjfh8HQPLpho51Rn7tE
      zVy8oZTOVQggemvsTmZjkiTQE3rLSXDv3NhiP4jRZf4eYCH1Y6Qib99CaE04CsVq
      GnEHfYzhgznGM+Z3aGqFG+XiNV1NdQeW4ocfXAL1YC19qvBPJVKZJX8prbn0ItA9
      LUzdF3aWnYdIm2Qp/cDc52azZkR0tQWsWMMnv40jGfgq0n6pBn+5ZiF/oZcmVrHm
      00gJ0S0bQKySo5Mp4toJPRUwY4kCiNdmbTwm2ejSmkqbxDlCJTKHYlZzrIjeOuvc
      dwIDAQAB
      -----END PUBLIC KEY-----


